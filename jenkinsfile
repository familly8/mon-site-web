pipeline {
    agent any
    
    environment {
        DEPLOY_PATH = '/var/www/html'
        SITE_URL = 'http://192.168.12.1'
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('üì• Checkout Code') {
            steps {
                checkout scm
                echo ' Code source r√©cup√©r√© depuis GitHub'
                sh 'ls -la'
            }
        }
        
        stage('üîç Validation HTML') {
            steps {
                script {
                    echo "V√©rification des fichiers HTML..."
                    def htmlFiles = findFiles(glob: '**/*.html')
                    if (htmlFiles.length == 0) {
                        error ' ERREUR: Aucun fichier HTML trouv√©!'
                    }
                    echo " Fichiers HTML trouv√©s: ${htmlFiles.length}"
                    
                    // V√©rifier les fichiers requis
                    def requiredFiles = ['index.html', 'about.html', 'contact.html']
                    requiredFiles.each { file ->
                        if (!fileExists(file)) {
                            error " ERREUR: Fichier manquant: ${file}"
                        }
                        echo " Fichier pr√©sent: ${file}"
                    }
                }
            }
        }
        
        stage(' Tests Qualit√©') {
            steps {
                sh '''
                    echo "D√©but des tests de qualit√©..."
                    
                    # V√©rifier la structure HTML
                    for file in *.html; do
                        echo " Test du fichier: $file"
                        
                        # V√©rifier DOCTYPE
                        if ! grep -q "<!DOCTYPE html>" "$file"; then
                            echo " $file: DOCTYPE HTML manquant"
                            exit 1
                        fi
                        
                        # V√©rifier title
                        if ! grep -q "<title>" "$file"; then
                            echo " $file: Balise <title> manquante"
                            exit 1
                        fi
                        
                        # V√©rifier charset
                        if ! grep -q "charset=UTF-8" "$file"; then
                            echo " $file: charset UTF-8 manquant"
                            exit 1
                        fi
                        
                        echo " $file: Tests de base pass√©s"
                    done
                    
                    # V√©rifier le CSS
                    if [ -f "assets/style.css" ]; then
                        echo " Fichier CSS pr√©sent"
                    else
                        echo " Fichier CSS manquant"
                        exit 1
                    fi
                    
                    echo " Tous les tests de qualit√© sont pass√©s!"
                '''
            }
        }
        
        stage(' Construction') {
            steps {
                echo "Construction de l'application..."
                sh '''
                    # Cr√©er un fichier de version
                    echo "Build: ${BUILD_NUMBER}" > version.txt
                    echo "Date: $(date)" >> version.txt
                    echo "Commit: ${GIT_COMMIT}" >> version.txt
                    
                    # Cr√©er une archive
                    tar -czf site-web-build-${BUILD_NUMBER}.tar.gz *.html assets/ version.txt
                    echo " Archive cr√©√©e: site-web-build-${BUILD_NUMBER}.tar.gz"
                '''
                
                archiveArtifacts artifacts: 'site-web-build-*.tar.gz', fingerprint: true
            }
        }
        
        stage(' D√©ploiement') {
            steps {
                script {
                    echo "D√©but du d√©ploiement..."
                    
                    // Sauvegarde avant d√©ploiement
                    sh """
                        echo " Cr√©ation d'une sauvegarde..."
                        sudo tar -czf /tmp/site-backup-\$(date +%Y%m%d-%H%M%S).tar.gz -C $DEPLOY_PATH . 2>/dev/null || true
                    """
                    
                    // Nettoyage et d√©ploiement
                    sh """
                        echo " Nettoyage du r√©pertoire de d√©ploiement..."
                        sudo rm -rf $DEPLOY_PATH/*
                        
                        echo " Copie des nouveaux fichiers..."
                        sudo cp -r *.html assets/ $DEPLOY_PATH/
                        
                        echo " Ajustement des permissions..."
                        sudo chown -R www-data:www-data $DEPLOY_PATH
                        sudo chmod -R 755 $DEPLOY_PATH
                        
                        echo " Red√©marrage de NGINX..."
                        sudo systemctl reload nginx
                    """
                }
            }
        }
        
        stage(' V√©rification') {
            steps {
                script {
                    echo "V√©rification du d√©ploiement..."
                    
                    // Attendre que le site soit disponible
                    sh '''
                        echo " Attente de la disponibilit√© du site..."
                        for i in {1..10}; do
                            if curl -f http://192.168.12.1/ > /dev/null 2>&1; then
                                echo " Site accessible!"
                                break
                            fi
                            echo "Tentative $i/10..."
                            sleep 3
                        done
                    '''
                    
                    // Tester toutes les pages
                    def pages = ["", "about.html", "contact.html"]
                    pages.each { page ->
                        sh """
                            if curl -f "http://192.168.12.1/${page}" > /dev/null 2>&1; then
                                echo " Page accessible: ${page}"
                            else
                                echo " Page inaccessible: ${page}"
                                exit 1
                            fi
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo " Construction #${BUILD_NUMBER} termin√©e - ${currentBuild.result}"
            publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: '.',
                reportFiles: 'index.html',
                reportName: 'Aper√ßu du Site'
            ])
        }
        success {
            echo " D√âPLOIEMENT R√âUSSI!"
            sh '''
                echo "=========================================="
                echo " SITE WEB ACCESSIBLE"
                echo "=========================================="
                echo "URL: http://$(curl -s ifconfig.me || echo "localhost")"
                echo "Build: ${BUILD_NUMBER}"
                echo "Date: $(date)"
                echo "=========================================="
            '''
        }
        failure {
            echo " D√âPLOIEMENT √âCHOU√â!"
            // Tentative de restauration
            sh '''
                echo " Tentative de restauration depuis la sauvegarde..."
                sudo tar -tzf /tmp/site-backup-*.tar.gz > /dev/null 2>&1 && \\
                sudo tar -xzf /tmp/site-backup-*.tar.gz -C /var/www/html/ && \\
                sudo systemctl reload nginx && \\
                echo " Restauration effectu√©e" || echo " Aucune sauvegarde disponible"
            '''
        }
        unstable {
            echo " Construction instable"
        }
    }
}
